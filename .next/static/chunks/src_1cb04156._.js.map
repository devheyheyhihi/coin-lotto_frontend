{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 10, "column": 0}, "map": {"version":3,"sources":["file:///Users/sinseonghyeon/Documents/GitHub/01-blockchain-projects/maxpia-project/coin_lotto/frontend/src/app/admin/page.tsx"],"sourcesContent":["'use client';\n\nimport { useState, useEffect, useCallback } from 'react';\nimport { ethers } from 'ethers';\nimport lotteryABIFile from '../../abis/Lottery.json';\nimport Link from 'next/link';\nimport { useSearchParams } from 'next/navigation';\n\n// Extends the window object to use a browser wallet provider like MetaMask.\ndeclare global {\n  interface Window {\n    ethereum?: any;\n  }\n}\n\nconst BNB_CHAIN_ID = '0x61';\nconst API_BASE_URL = 'http://localhost:3001';\nconst lotteryABI = lotteryABIFile.abi;\n\nexport default function AdminPage() {\n  const [account, setAccount] = useState<string | null>(null);\n  const [isCorrectNetwork, setIsCorrectNetwork] = useState(false);\n  const [isProcessing, setIsProcessing] = useState(false);\n  const [isOwner, setIsOwner] = useState(false); // Note: Now checks ownership of ANY room.\n  const [error, setError] = useState<string | null>(null);\n  const [successMessage, setSuccessMessage] = useState<string | null>(null);\n\n  // This function now only checks if the connected account is the owner of ANY of the lottery contracts.\n  // The backend will handle the true authorization.\n  const checkIsOwner = useCallback(async () => {\n    if (window.ethereum && isCorrectNetwork && account) {\n        try {\n            const roomsResponse = await fetch(`${API_BASE_URL}/rooms`);\n            const rooms = await roomsResponse.json();\n            if (!rooms || rooms.length === 0) {\n                throw new Error(\"Could not fetch room configurations.\");\n            }\n            \n            const provider = new ethers.BrowserProvider(window.ethereum);\n            // Check ownership of the first contract as a proxy for all of them\n            // since the owner is the same for all contracts deployed by the script.\n            const lotteryContract = new ethers.Contract(rooms[0].contractAddress, lotteryABI, provider);\n            const ownerAddress = await lotteryContract.owner();\n            setIsOwner(ownerAddress.toLowerCase() === account.toLowerCase());\n\n        } catch (e) {\n            console.error(\"Could not check owner status:\", e);\n            setIsOwner(false);\n        }\n    } else {\n        setIsOwner(false);\n    }\n  }, [account, isCorrectNetwork]);\n\n  const checkNetwork = useCallback(async () => {\n    if (window.ethereum) {\n      try {\n        const chainId = await window.ethereum.request({ method: 'eth_chainId' });\n        setIsCorrectNetwork(chainId === BNB_CHAIN_ID);\n      } catch (error) {\n        console.error(\"Failed to check network:\", error);\n        setIsCorrectNetwork(false);\n      }\n    }\n  }, []);\n\n  const connectWallet = async () => {\n    if (typeof window.ethereum !== 'undefined') {\n      try {\n        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });\n        setAccount(accounts[0]);\n      } catch (err: any) {\n        console.error(\"Error connecting to MetaMask\", err);\n        setError(\"Error connecting to MetaMask.\");\n      }\n    } else {\n      setError('Please install MetaMask.');\n    }\n  };\n\n  const handleStartDrawAll = async () => {\n    setIsProcessing(true);\n    setError(null);\n    setSuccessMessage(null);\n    try {\n        const response = await fetch(`${API_BASE_URL}/start-draw-all`, { method: 'POST' });\n        const data = await response.json();\n\n        if (data.success) {\n            setSuccessMessage(data.message || \"Draw process for all rooms has been initiated.\");\n        } else {\n            throw new Error(data.message || \"An unknown error occurred on the server.\");\n        }\n    } catch (err: any) {\n        console.error(\"Failed to start draws:\", err);\n        setError(`Error: ${err.message}`);\n    } finally {\n        setIsProcessing(false);\n    }\n  };\n\n  useEffect(() => {\n    const handleAccountsChanged = (accounts: string[]) => {\n      setAccount(accounts.length > 0 ? accounts[0] : null);\n    };\n    const handleChainChanged = () => checkNetwork();\n\n    if (window.ethereum) {\n      window.ethereum.on('accountsChanged', handleAccountsChanged);\n      window.ethereum.on('chainChanged', handleChainChanged);\n      (async () => {\n        const accounts = await window.ethereum.request({ method: 'eth_accounts' });\n        handleAccountsChanged(accounts);\n        await checkNetwork();\n      })();\n      return () => {\n        window.ethereum.removeListener('accountsChanged', handleAccountsChanged);\n        window.ethereum.removeListener('chainChanged', handleChainChanged);\n      };\n    }\n  }, [checkNetwork]);\n\n  useEffect(() => {\n    checkIsOwner();\n  }, [account, isCorrectNetwork, checkIsOwner]);\n\n  const renderContent = () => {\n    if (!account) {\n      return <button onClick={connectWallet} className=\"px-8 py-4 bg-blue-600 text-white font-bold text-2xl rounded-lg hover:bg-blue-500\">Connect Wallet</button>;\n    }\n    if (!isCorrectNetwork) {\n      return <p className=\"text-yellow-400\">Please switch to BNB Testnet.</p>;\n    }\n    if (!isOwner) {\n        return <p className=\"text-red-500\">You are not the owner of the contracts.</p>;\n    }\n    return (\n        <button\n            onClick={handleStartDrawAll}\n            disabled={isProcessing}\n            className=\"px-8 py-4 bg-red-600 text-white font-bold text-2xl rounded-lg hover:bg-red-500 disabled:bg-gray-600\"\n        >\n            {isProcessing ? 'Initiating Draws...' : 'Start Draw For All Rooms'}\n        </button>\n    );\n  };\n\n  return (\n    <main className=\"flex min-h-screen flex-col items-center justify-center bg-gray-900 text-white p-4\">\n        {isProcessing && (\n            <div className=\"absolute inset-0 bg-black bg-opacity-70 flex flex-col justify-center items-center z-50\">\n                <div className=\"w-16 h-16 border-4 border-yellow-400 border-t-transparent rounded-full animate-spin\"></div>\n                <p className=\"mt-4 text-white text-xl font-semibold\">Processing Request...</p>\n            </div>\n        )}\n        <div className=\"absolute top-5 left-5\">\n            <Link href=\"/\" className=\"text-blue-400 hover:underline\">‚Üê Back to Lobby</Link>\n        </div>\n        <div className=\"text-center\">\n            <h1 className=\"text-5xl font-bold mb-8\">Global Admin Panel</h1>\n            <div className=\"space-y-4\">\n                {renderContent()}\n                {successMessage && <p className=\"text-green-400 mt-4 text-lg\">{successMessage}</p>}\n                {error && <p className=\"text-red-500 mt-4\">{error}</p>}\n            </div>\n        </div>\n    </main>\n  );\n} "],"names":[],"mappings":"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","debugId":null}}]
}